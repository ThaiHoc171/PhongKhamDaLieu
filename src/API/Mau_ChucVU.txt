using System;

namespace Domain.Entities
{
	public class ChucVu
	{
		public int ChucVuID { get; private set; }
		public string TenChucVu { get; private set; }
		public string? MoTa { get; private set; }
		public DateTime NgayTao { get; private set; }
		public string TrangThai { get; private set; }

		// Tạo mới
		public ChucVu(string tenChucVu, string? moTa)
		{
			if (string.IsNullOrWhiteSpace(tenChucVu))
				throw new ArgumentException("Tên chức vụ không hợp lệ");

			TenChucVu = tenChucVu;
			MoTa = moTa;
			NgayTao = DateTime.UtcNow;
			TrangThai = "Hoạt động";
		}

		// Map từ DB
		public ChucVu(
			int chucVuID,
			string tenChucVu,
			string? moTa,
			DateTime ngayTao,
			string trangThai)
		{
			ChucVuID = chucVuID;
			TenChucVu = tenChucVu;
			MoTa = moTa;
			NgayTao = ngayTao;
			TrangThai = trangThai;
		}

		public void CapNhat(string tenChucVu, string? moTa)
		{
			if (string.IsNullOrWhiteSpace(tenChucVu))
				throw new ArgumentException("Tên chức vụ không hợp lệ");

			TenChucVu = tenChucVu;
			MoTa = moTa;
		}

		public void CapNhatTrangThai(string trangThai)
		{
			if (string.IsNullOrWhiteSpace(trangThai))
				throw new ArgumentException("Trạng thái không hợp lệ");

			TrangThai = trangThai;
		}
	}
}
using Domain.Entities;

namespace Application.Interfaces
{
	public interface IChucVuRepository
	{
		Task<List<ChucVu>> GetAllAsync();
		Task<ChucVu?> GetByIdAsync(int id);
		Task AddAsync(ChucVu chucVu);
		Task UpdateAsync(ChucVu chucVu);
	}
}
using Application.Interfaces;
using Domain.Entities;
using Microsoft.Data.SqlClient;
using Microsoft.Extensions.Configuration;

namespace Infrastructure.Repositories;

public class ChucVuRepository : IChucVuRepository
{
	private readonly string _connectionString;

	public ChucVuRepository(IConfiguration config)
	{
		_connectionString = config.GetConnectionString("DefaultConnection")
			?? throw new ArgumentNullException("Connection string not found");
	}

	public async Task<List<ChucVu>> GetAllAsync()
	{
		const string sql = @" SELECT ChucVuID, TenChucVu, MoTa, NgayTao, TrangThai
							FROM ChucVu";

		var list = new List<ChucVu>();

		await using var conn = new SqlConnection(_connectionString);
		await using var cmd = new SqlCommand(sql, conn);

		await conn.OpenAsync();
		await using var reader = await cmd.ExecuteReaderAsync();

		while (await reader.ReadAsync())
		{
			list.Add(MapToEntity(reader));
		}

		return list;
	}

	public async Task<ChucVu?> GetByIdAsync(int id)
	{
		const string sql ="SELECT ChucVuID, TenChucVu, MoTa, NgayTao, TrangThai FROM ChucVu WHERE ChucVuID = @ChucVuID";

		await using var conn = new SqlConnection(_connectionString);
		await using var cmd = new SqlCommand(sql, conn);
		cmd.Parameters.AddWithValue("@ChucVuID", id);

		await conn.OpenAsync();
		await using var reader = await cmd.ExecuteReaderAsync();

		return await reader.ReadAsync() ? MapToEntity(reader) : null;
	}

	public async Task AddAsync(ChucVu cv)
	{
		const string sql = @"INSERT INTO ChucVu (TenChucVu, MoTa) VALUES (@TenChucVu, @MoTa)";

		await using var conn = new SqlConnection(_connectionString);
		await using var cmd = new SqlCommand(sql, conn);

		cmd.Parameters.AddWithValue("@TenChucVu", cv.TenChucVu);
		cmd.Parameters.AddWithValue("@MoTa", (object?)cv.MoTa ?? DBNull.Value);
		cmd.Parameters.AddWithValue("@TrangThai", cv.TrangThai);
		cmd.Parameters.AddWithValue("@NgayTao", cv.NgayTao);

		await conn.OpenAsync();
		await cmd.ExecuteNonQueryAsync();
	}

	public async Task UpdateAsync(ChucVu cv)
	{
		const string sql = @"UPDATE ChucVu SET TenChucVu = @TenChucVu, MoTa = @MoTa, TrangThai = @TrangThai WHERE ChucVuID = @ChucVuID";

		await using var conn = new SqlConnection(_connectionString);
		await using var cmd = new SqlCommand(sql, conn);

		cmd.Parameters.AddWithValue("@ChucVuID", cv.ChucVuID);
		cmd.Parameters.AddWithValue("@TenChucVu", cv.TenChucVu);
		cmd.Parameters.AddWithValue("@MoTa", (object?)cv.MoTa ?? DBNull.Value);
		cmd.Parameters.AddWithValue("@TrangThai", cv.TrangThai);

		await conn.OpenAsync();
		await cmd.ExecuteNonQueryAsync();
	}

	private static ChucVu MapToEntity(SqlDataReader reader)
	{
		return new ChucVu(
			chucVuID: reader.GetInt32(0),
			tenChucVu: reader.GetString(1),
			moTa: reader.IsDBNull(2) ? null : reader.GetString(2),
			ngayTao: reader.GetDateTime(3),
			trangThai: reader.GetString(4)
		);
	}
}
namespace Application.DTOs;

public class ChucVuResponseDTO
{
	public int ChucVuID { get; set; }
	public string TenChucVu { get; set; } = default!;
	public string? MoTa { get; set; }
	public DateTime NgayTao { get; set; }
}

public class ChucVuRequestDTO
{
	public string TenChucVu { get; set; } = default!;
	public string? MoTa { get; set; }
}

using Application.DTOs;
using Application.Interfaces;
using Domain.Entities;

namespace Services
{
	public class ChucVuService
	{
		private readonly IChucVuRepository _repo;

		public ChucVuService(IChucVuRepository repo)
		{
			_repo = repo;
		}
		public async Task<List<ChucVuResponseDTO>> DanhSachChucVuAsync()
		{
			var list = await _repo.GetAllAsync();

			return list.Select(MapToDto).ToList();
		}
		public async Task<ChucVuResponseDTO?> LayChucVuTheoIdAsync(int id)
		{
			var cv = await _repo.GetByIdAsync(id);
			if (cv == null) return null;

			return MapToDto(cv);
		}
		public async Task ThemChucVuAsync(ChucVuRequestDTO dto)
		{
			var cv = new ChucVu(dto.TenChucVu, dto.MoTa);
			await _repo.AddAsync(cv);
		}

		public async Task<bool> CapNhatChucVuAsync(int id, ChucVuRequestDTO dto)
		{
			var cv = await _repo.GetByIdAsync(id);
			if (cv == null) return false;

			cv.CapNhat(dto.TenChucVu, dto.MoTa);
			await _repo.UpdateAsync(cv);

			return true;
		}

		public async Task<bool> CapNhatTrangThaiChucVuAsync(int id, string trangThaiMoi)
		{
			var cv = await _repo.GetByIdAsync(id);
			if (cv == null) return false;

			cv.CapNhatTrangThai(trangThaiMoi);
			await _repo.UpdateAsync(cv);

			return true;
		}

		private static ChucVuResponseDTO MapToDto(ChucVu cv)
		{
			return new ChucVuResponseDTO
			{
				ChucVuID = cv.ChucVuID,
				TenChucVu = cv.TenChucVu,
				MoTa = cv.MoTa,
				NgayTao = cv.NgayTao
			};
		}
	}
}
using Microsoft.AspNetCore.Mvc;
using Application.DTOs;
using Services;

namespace API.Controllers
{
	[ApiController]
	[Route("api/[controller]")]
	public class ChucVuController : ControllerBase
	{
		private readonly ChucVuService _chucVuService;

		public ChucVuController(ChucVuService chucVuService)
		{
			_chucVuService = chucVuService;
		}

		// GET: api/ChucVu
		[HttpGet]
		public async Task<IActionResult> LayDanhSachChucVu()
		{
			var result = await _chucVuService.DanhSachChucVuAsync();
			return Ok(result);
		}

		// GET: api/ChucVu/{id}
		[HttpGet("{id}")]
		public async Task<IActionResult> LayChucVuTheoID(int id)
		{
			var result = await _chucVuService.LayChucVuTheoIdAsync(id);

			if (result == null)
				return NotFound(new { message = "Chức vụ không tồn tại." });

			return Ok(result);
		}

		// POST: api/ChucVu
		[HttpPost]
		public async Task<IActionResult> ThemChucVu([FromBody] ChucVuRequestDTO dto)
		{
			await _chucVuService.ThemChucVuAsync(dto);

			return Ok(new
			{
				message = "Thêm chức vụ thành công."
			});
		}

		// PUT: api/ChucVu/{id}
		[HttpPut("{id}")]
		public async Task<IActionResult> CapNhatChucVu(int id, [FromBody] ChucVuRequestDTO dto)
		{
			var result = await _chucVuService.CapNhatChucVuAsync(id, dto);

			if (!result)
				return NotFound(new { message = "Chức vụ không tồn tại." });

			return Ok(new
			{
				message = "Cập nhật chức vụ thành công."
			});
		}

		// PUT: api/ChucVu/{id}/trangthai
		[HttpPut("{id}/trangthai")]
		public async Task<IActionResult> CapNhatTrangThai(int id, [FromBody] string trangThaiMoi)
		{
			var result = await _chucVuService.CapNhatTrangThaiChucVuAsync(id, trangThaiMoi);

			if (!result)
				return NotFound(new { message = "Chức vụ không tồn tại." });

			return Ok(new
			{
				message = "Cập nhật trạng thái chức vụ thành công."
			});
		}
	}
}
